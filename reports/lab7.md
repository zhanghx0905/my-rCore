# Report

2018011365 张鹤潇

### 编程作业

为简单起见，我只在索引节点层对文件系统进行改造，编写了供 `ROOT_INODE` 调用的方法 `create_hard_link`，`remove_hard_link` 和 `count_hard_links`：通过在根目录下增删 `DirEntry` 创建/删除硬链接，统计硬链接个数时遍历根目录；并在内核新增三个硬链接相关的系统调用，调用文件系统接口实现相应功能。

为了兼容测例，我将系统调用的参数数量修改为 5 个；为保证前向兼容，我又将前六章实现的系统调用也移植到内核中。其中，测例的 `exec` 系统调用不支持参数传递，我将内核的 `sys_exec` 也修改为不传递参数的版本。 

### 思考题

#### 1

为实现多级目录，我设想对 `easy-fs` 做如下改造：

- 在磁盘数据结构层，允许在 `DirEntry` 中存储子目录的 `DiskInode`，从而以线性表索引子目录，这可能需要增加 `DirEntry` 中存储的信息，如 Inode 类型等.
- 在索引节点层，实现子目录创建、子目录搜索、遍历路径等相关功能。

在 OS 内核，对接文件系统，实现创建子目录、打开目录、遍历路径等系统调用，使用户程序能使用多级目录。

#### 2

按目前硬链接的实现方式，子目录索引的 `DirEntry` 可能指向父目录的 `DiskInode`，存在环路的可能。

两种解决方式：

- 禁止为目录创建硬链接
- 限制路径的长度，避免无限循环

在 Ubuntu 18.04 上，无法为目录创建硬链接，

```sh
mkdir ~/test
cd ~/test
ln ~/test test
# ln: hard link not allowed for directory
```

可以为目录创建软链接

```sh
ln -s ~/test test
for i in $(seq 1 40); do cd test; done
# 此时路径长度达到最大，再次 cd test 将回到 ~/test
```

